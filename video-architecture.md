# 视频编辑器架构设计

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              VideoEditor Page (index.vue)                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              UI 层 (Vue 组件)                                    │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────────┐   │ │
│  │  │  EffectsPanel    │  │  VideoPreview    │  │      TimeLine                │   │ │
│  │  │  效果调节面板      │  │  视频预览组件     │  │      时间轴组件               │   │ │
│  │  │                  │  │                  │  │                              │   │ │
│  │  │  - 倍速控制       │  │  ┌────────────┐  │  │  - 缩略图显示                 │   │ │
│  │  │  - 对比度        │  │  │  Canvas    │  │  │  - 播放头拖拽                 │   │ │
│  │  │  - 饱和度        │  │  │  (WebGL)   │  │  │  - 时间刻度尺                 │   │ │
│  │  │  - 色温          │  │  └────────────┘  │  │  - 播放控制                   │   │ │
│  │  │  - 阴影          │  │        ↑         │  │  - 倍速联动                   │   │ │
│  │  │  - 高光          │  │  WebGLVideo     │  │                              │   │ │
│  │  │  - 导出/重置     │  │  Renderer       │  │                              │   │ │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                          │                                           │
│                                          ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           状态管理层 (Vue Composition API)                       │ │
│  │                                                                                 │ │
│  │  speed, contrast, saturation, temperature, shadows, highlights                  │ │
│  │  videoFile, videoUrl, videoElement, processingMode, isProcessing               │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              VideoEditor 类 (Video.ts)                               │
│                                    抽象层                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │  interface VideoWrapper {                                                       │ │
│  │    load(): Promise<void>                                                        │ │
│  │    applyFilters(file, options): Promise<Blob>                                   │ │
│  │    setProgressCallback(callback): void                                          │ │
│  │    destroy(): Promise<void>                                                     │ │
│  │  }                                                                              │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                           │                                          │
│                          ┌────────────────┴────────────────┐                         │
│                          ▼                                 ▼                         │
│              ┌─────────────────────┐           ┌─────────────────────┐               │
│              │   FFmpegWrapper     │           │   WebAVWrapper      │               │
│              │   (ffmpeg/index.ts) │           │   (webav/index.ts)  │               │
│              └─────────────────────┘           └─────────────────────┘               │
└─────────────────────────────────────────────────────────────────────────────────────┘
                          │                                 │
                          ▼                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   底层处理引擎                                        │
│  ┌──────────────────────────────────┐    ┌──────────────────────────────────────┐   │
│  │         FFmpeg.wasm              │    │           WebCodecs API              │   │
│  │                                  │    │                                      │   │
│  │  ┌────────────────────────────┐  │    │  ┌────────────────────────────────┐  │   │
│  │  │  eq 滤镜                    │  │    │  │  WebGLFilterRenderer          │  │   │
│  │  │  - contrast                │  │    │  │  (WebGL 硬件加速)              │  │   │
│  │  │  - saturation              │  │    │  │                                │  │   │
│  │  │  - gamma (阴影)            │  │    │  │  使用 shaders.ts 着色器        │  │   │
│  │  │  - brightness (高光)       │  │    │  └────────────────────────────────┘  │   │
│  │  │  - gamma_r/gamma_b (色温)  │  │    │                                      │   │
│  │  └────────────────────────────┘  │    │  ┌────────────────────────────────┐  │   │
│  │                                  │    │  │  MP4Clip + Combinator          │  │   │
│  │  ┌────────────────────────────┐  │    │  │  (帧提取 + 编码)               │  │   │
│  │  │  setpts 滤镜 (倍速)         │  │    │  └────────────────────────────────┘  │   │
│  │  └────────────────────────────┘  │    │                                      │   │
│  └──────────────────────────────────┘    └──────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 统一着色器架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           shaders.ts (统一着色器代码)                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │  export interface FilterParams { contrast, saturation, temperature, ... }       │ │
│  │  export const DEFAULT_FILTER_PARAMS = { ... }                                   │ │
│  │  export const VERTEX_SHADER = `...`                                             │ │
│  │  export const FRAGMENT_SHADER = `...`                                           │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                          │                                 │
                          ▼                                 ▼
     ┌────────────────────────────────────┐    ┌────────────────────────────────────┐
     │  VideoPreview/WebGLRenderer.ts     │    │  webav/WebGLFilterRenderer.ts      │
     │  (实时预览用)                       │    │  (视频导出用)                       │
     │                                    │    │                                    │
     │  class WebGLVideoRenderer {        │    │  class WebGLFilterRenderer {       │
     │    // 渲染到 HTMLCanvasElement     │    │    // 渲染到 OffscreenCanvas       │
     │    // 输入: HTMLVideoElement       │    │    // 输入: VideoFrame             │
     │    // 持续渲染 (RAF)               │    │    // 逐帧处理                      │
     │  }                                 │    │  }                                 │
     └────────────────────────────────────┘    └────────────────────────────────────┘
                          │                                 │
                          ▼                                 ▼
                 ┌─────────────────┐               ┌─────────────────┐
                 │   实时预览       │               │   视频导出       │
                 │   (效果一致)     │ ◄──────────► │   (效果一致)     │
                 └─────────────────┘               └─────────────────┘
```

## 数据流图

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户交互                                           │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    ▼                    ▼                    ▼
           ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
           │  上传视频      │    │  调整效果参数   │    │  点击导出      │
           └───────────────┘    └───────────────┘    └───────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
           │  videoFile    │    │  speed        │    │  applyFilters │
           │  videoUrl     │    │  contrast     │    │  (VideoEditor)│
           │  videoElement │    │  saturation   │    └───────────────┘
           └───────────────┘    │  temperature  │            │
                    │           │  shadows      │            │
                    │           │  highlights   │            │
                    │           └───────────────┘            │
                    │                    │                    │
                    ▼                    ▼                    ▼
           ┌───────────────────────────────────────────────────────────┐
           │                     VideoPreview 组件                      │
           │  ┌─────────────────────────────────────────────────────┐  │
           │  │  <video> (隐藏) ──► WebGLVideoRenderer ──► <canvas> │  │
           │  │                         │                           │  │
           │  │                    使用 shaders.ts                  │  │
           │  │                    实时渲染滤镜效果                   │  │
           │  └─────────────────────────────────────────────────────┘  │
           └───────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                              ┌─────────────────────┐
                              │   TimeLine 组件     │
                              │   - 显示缩略图      │
                              │   - 播放控制        │
                              │   - 倍速联动        │
                              └─────────────────────┘

                                    导出流程
                                         │
                    ┌────────────────────┴────────────────────┐
                    ▼                                         ▼
           ┌───────────────────┐                     ┌───────────────────┐
           │   FFmpeg 模式      │                     │   WebAV 模式       │
           │                   │                     │                   │
           │  1. 写入虚拟文件系统 │                     │  1. 创建 MP4Clip   │
           │  2. 构建 eq 滤镜    │                     │  2. 逐帧提取       │
           │  3. 执行 ffmpeg    │                     │  3. WebGL 处理     │
           │  4. 读取输出文件    │                     │  4. Combinator 编码│
           │  5. 假进度动画     │                     │  5. 输出 Blob      │
           └───────────────────┘                     └───────────────────┘
                    │                                         │
                    └────────────────────┬────────────────────┘
                                         ▼
                              ┌─────────────────────┐
                              │   下载视频文件       │
                              │   (自动命名)        │
                              └─────────────────────┘
```

## 文件结构

```
src/
├── page/
│   └── VideoEditor/
│       └── index.vue              # 视频编辑器主页面
│
├── components/
│   ├── EffectsPanel/
│   │   └── index.vue              # 效果调节面板（配置驱动）
│   │
│   ├── VideoPreview/
│   │   ├── index.vue              # WebGL 视频预览组件
│   │   └── WebGLRenderer.ts       # 预览用 WebGL 渲染器
│   │
│   └── TimeLine/
│       └── TimeLine.vue           # 时间轴组件
│
└── package/
    └── Video/
        ├── Video.ts               # 抽象层（VideoEditor 类）
        ├── types.ts               # 类型定义（VideoFilterOptions）
        ├── shaders.ts             # 统一着色器代码 ⭐
        │
        ├── ffmpeg/
        │   └── index.ts           # FFmpegWrapper 实现
        │
        └── webav/
            ├── index.ts           # WebAVWrapper 实现
            └── WebGLFilterRenderer.ts  # 导出用 WebGL 渲染器
```

## 滤镜处理顺序

预览和导出使用相同的滤镜处理顺序，确保效果一致：

```
输入像素 (RGB)
     │
     ▼
┌─────────────────┐
│ 1. 对比度调整    │  rgb = (rgb - 0.5) * contrast + 0.5
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ 2. 饱和度调整    │  gray = dot(rgb, [0.299, 0.587, 0.114])
│                 │  rgb = mix(gray, rgb, saturation)
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ 3. 阴影调整      │  gamma = 1.0 / pow(shadows, 0.6)
│   (gamma 曲线)  │  rgb = pow(rgb, gamma)
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ 4. 高光调整      │  brightness = (highlights - 1.0) * 0.3
│   (亮度)        │  rgb = rgb + brightness
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ 5. 色温调整      │  暖色: r+, g+, b-
│   (红蓝通道)    │  冷色: r-, g-, b+
└─────────────────┘
     │
     ▼
┌─────────────────┐
│ 6. clamp(0, 1)  │  确保颜色值在有效范围内
└─────────────────┘
     │
     ▼
输出像素 (RGB)
```

## 两种处理模式对比

| 特性 | FFmpeg 模式 | WebAV 模式 |
|------|------------|-----------|
| **底层技术** | FFmpeg.wasm (WebAssembly) | WebCodecs API |
| **预加载** | 需要（~30MB） | 不需要 |
| **浏览器支持** | 所有现代浏览器 | Chrome 94+, Edge 94+ |
| **滤镜实现** | eq 滤镜 + gamma_r/gamma_b | WebGL 着色器 |
| **硬件加速** | 无 | 支持 GPU 加速 |
| **与预览一致性** | 接近（参数调优） | 完全一致（相同着色器） |
| **进度显示** | 假进度动画 | 真实进度 |
| **处理速度** | 较慢 | 较快 |

## 关键设计决策

1. **统一着色器架构**
   - 将 WebGL 着色器代码抽离到 `shaders.ts`
   - 预览和 WebAV 导出共享同一份代码
   - 修改一处即可同步更新所有效果

2. **抽象层设计**
   - `VideoEditor` 类封装两种处理模式
   - 统一的 `VideoWrapper` 接口
   - 业务层无需关心底层实现

3. **配置驱动 UI**
   - `EffectsPanel` 通过配置数组定义效果
   - 新增效果只需添加配置项
   - 减少重复代码

4. **WebGL 实时预览**
   - 替代 CSS 滤镜，效果更精确
   - 与导出效果完全一致
   - GPU 加速，性能优异

5. **假进度优化**
   - FFmpeg 模式下模拟平滑进度
   - 提升用户体验
   - 避免进度条卡顿

